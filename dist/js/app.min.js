function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function removeSlash(e){return e.replace(/\/$/,"")}function goToByScroll(e){$("html,body").animate({scrollTop:e.offset().top-65},"slow")}function isLocalStorageNameSupported(){var e="test",t=window.sessionStorage;try{return t.setItem(e,"1"),t.removeItem(e),!0}catch(n){return!1}}function getUrlParams(){var e=location.search.substring(1),t=e?JSON.parse('{"'+e.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(e,t){return""===e?t:decodeURIComponent(t)}):{};return t}function notifyUser(e,t){var n=$("#notification"),o=n.find(".message");n.removeClass("success info error").addClass(t).removeClass("hide"),o.text(e),clearTimeout(t1),clearTimeout(t2),t1=window.setTimeout(function(){n.addClass("hide"),t2=window.setTimeout(function(){n.removeClass(t),o.text("")},1e3)},4500)}var userLang=navigator.language||navigator.userLanguage,config=[{title:{en:"Home",de:"Home"},id:"home",slug:["/home","/",""],hbsPath:"/pages/home.hbs"},{title:{en:"Rings",de:"Ringe"},id:"rings",slug:["/rings","/ringe"],hbsPath:"/pages/rings.hbs"},{title:{en:"Necklaces",de:"Ketten"},id:"necklaces",slug:["/necklaces","/ketten"],hbsPath:"/pages/necklaces.hbs"},{title:{en:"Pendants",de:"Anhänger"},id:"pendants",slug:["/pendants","/anhaenger"],hbsPath:"/pages/pendants.hbs"},{title:{en:"Bracelets",de:"Armbänder"},id:"bracelets",slug:["/bracelets","/armbaender","/armband"],hbsPath:"/pages/bracelets.hbs"},{title:{en:"<3",de:"<3"},id:"likes",slug:["/likes","/yourlikes","/mylikes"],hbsPath:"/pages/likes.hbs"},{title:{en:"Checkout",de:"Kasse"},id:"checkout",slug:["/checkout","/kasse"],hbsPath:"/pages/checkout.hbs"},{title:{en:"Confirmation",de:"Bestätigung"},id:"confirmation",slug:["/confirmation"],hbsPath:"/pages/confirmation.hbs"},{title:{en:"GTC",de:"AGB"},id:"terms",slug:["/terms","/agb"],hbsPath:"/pages/terms.hbs"},{title:{en:"Imprint",de:"Impressum"},id:"imprint",slug:["/imprint","/impressum"],hbsPath:"/pages/imprint.hbs"},{title:{en:"Shipping & Retour",de:"Versand & Rückgabe"},id:"shipping",slug:["/shipping","/versand"],hbsPath:"/pages/shipping.hbs"},{title:{en:"Privacy",de:"Datenschutz"},id:"privacy",slug:["/privacy","/datenschutz"],hbsPath:"/pages/privacy.hbs"},{title:{en:"The Brand",de:"Die Marke"},id:"brand",slug:["/brand","/marke"],hbsPath:"/pages/brand.hbs"},{title:{en:"Developer Page",de:"Entwickler Seite"},id:"f12",slug:["/f12"],hbsPath:"/pages/f12.hbs"},{title:{en:"404",de:"404"},id:"404",slug:["/404"],hbsPath:"/pages/404.hbs"}],t1,t2;jQuery.fn.addTempClass=function(e,t){var n=$(this[0]);n.addClass(e),window.setTimeout(function(){n.removeClass(e)},t)};var App=function(e){var t=this;this.model=e,this.updateFromLocalStorage(),this.getCopy().then(function(){t.getProducts()}),this.initRouting(),this.initNavigation()};App.prototype.saveUser=function(){isLocalStorageNameSupported()&&(localStorage.einzl_user=JSON.stringify(einzl.user))},App.prototype.changeLanguageTo=function(e){einzl.user.lang=e,$("body").attr("data-active-lang",einzl.user.lang),this.getCopy().then(function(){$.each(einzl.pages,function(e,t){this.view&&(this.view.remove(),delete this.view),"active"==e&&this.start()}),einzl.cart.createView()}),einzl.app.saveUser()},App.prototype.insertCopy=function(e){var t=$("<div></div>").append(e);return t.find("[data-copy]").each(function(){var e=einzl.copy[$(this).attr("data-copy")];$(this).html(e)}),t.find("[data-placeholder]").each(function(){var e=einzl.copy.placeholders[$(this).attr("data-placeholder")];$(this).attr("placeholder",e)}),t.html()},App.prototype.getCopy=function(){return $.getJSON("copy/"+einzl.user.lang+".json",function(e){einzl.copy=e.copy,einzl.deferreds.copy.resolve()}).done(function(){$("[data-copy]").each(function(){var e=einzl.copy[$(this).attr("data-copy")];$(this).html(e)}),window.setTimeout(function(){notifyUser(einzl.copy.messages.welcome[getRandomInt(0,einzl.copy.messages.welcome.length-1)],"success")},2e3)})},App.prototype.updateFromLocalStorage=function(){if(isLocalStorageNameSupported()&&localStorage.einzl_user){var e=JSON.parse(localStorage.einzl_user);$.extend(einzl.user,e)}$("body").attr("data-active-lang",einzl.user.lang),this.handleLikes(!0)},App.prototype.handleLikes=function(e){var t=this;if(e)einzl.deferreds.product.then(function(){$.each(einzl.user.likes,function(e,t){var n=!1;t&&$.each(einzl.products,function(t,o){return o.model.id===e?(n=!0,!1):void 0}),n||(console.log("delete like"),delete einzl.user.likes[e])}),t.handleLikes()});else{var n=!1;$.each(einzl.user.likes,function(e,t){return t?(n=!0,!1):void 0}),n?$("html").addClass("has-likes"):$("html").removeClass("has-likes")}},App.prototype.getProducts=function(){var e=this,t={action:"getProducts"};return this.askServer(t).done(function(t){t&&t.status?e.getTemplate("modules/product").then(function(e){einzl.templates.product=e,$.each(t.result,function(e){einzl.products[e]=new Product(this)}),einzl.deferreds.product.resolve()}):(notifyUser(einzl.copy.messages.noConnection,"error"),console.log("GET PRODUCTS FAILED"),console.log(t))})},App.prototype.askServer=function(e){return $.ajax({type:"POST",dataType:"json",url:"php/ajax.php",data:e}).done(function(e){}).fail(function(t,n,o){console.log("AJAX Call failed"),console.log("tried to send this data:"),console.log(e),console.log("response data:"),console.log(t),console.log(n),console.log(o)})},App.prototype.initNavigation=function(){var e=this;$(".hamburger-button").on("vclick",function(e){var t=$(e.currentTarget),n=$(".cart-button");t.hasClass("open")?(t.removeClass("open"),$("header nav").removeClass("open"),$("body").removeClass("no-scroll-mobile")):(t.addClass("open"),$("header nav").addClass("open"),$("body").addClass("no-scroll-mobile"),n.removeClass("open"),$("aside.cart-container").removeClass("open")),e.preventDefault(),e.stopPropagation()}),$(".cart-button").on("vclick",function(e){var t=$(e.currentTarget),n=$(".hamburger-button");t.hasClass("open")?(t.removeClass("open"),$("aside.cart-container").removeClass("open"),$("body").removeClass("no-scroll-mobile")):(t.addClass("open"),$("aside.cart-container").addClass("open"),$("body").addClass("no-scroll-mobile"),n.removeClass("open"),$("header nav").removeClass("open")),e.preventDefault(),e.stopPropagation()}),$(".language-button span").on("vclick",function(t){var n=$(t.currentTarget);e.changeLanguageTo(n.attr("data-language"))}),this.initAppRoutingLinks()},App.prototype.initAppRoutingLinks=function(){Modernizr.history&&($("a").off("vclick"),$("a").not('[target="_blank"]').on("vclick",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).attr("href"),n=$(this).attr("title"),o=window.location.pathname;o!==t&&History.pushState("",n,t),$("header nav").removeClass("open")}))},App.prototype.subscribe=function(e){var t={action:"subscribe",user:e};return this.askServer(t).done(function(e){console.log("user successfully subscribed"),console.log(e),notifyUser(einzl.copy.messages.nl_subscribed,"success")}).fail(function(e){console.log("something is wrong with that email"),console.log(e),notifyUser(einzl.copy.messages.nl_error,"error")})},App.prototype.findDestination=function(e){var t=null;return $.each(this.model.routes,function(){var n=!1;return $.each(this.slug,function(t,o){return o===e?(n=!0,!1):void 0}),n?(t=this,!1):void 0}),t?t:this.findDestination("/404")},App.prototype.route=function(e){e||(e=removeSlash(window.location.pathname)),console.log("route to: "+e);var t=this.findDestination(e);$("main").children("section").detach(),$("body").addClass("loading"),einzl.pages[t.id]&&einzl.pages[t.id].view&&einzl.pages[t.id].view.length>0?einzl.pages[t.id].start():(einzl.pages[t.id]=new Page(t),einzl.pages[t.id]="checkout"==t.id?new Checkout(t):"confirmation"==t.id?new Confirmation(t):new Page(t),einzl.pages[t.id].start()),document.title=t.title[einzl.user.lang]+" - Einzelstück",$("body").attr("active-page",t.id),ga("send","pageview"),$("header nav a").removeClass("active").filter('[href="'+t.slug[0]+'"]').addClass("active"),$(".cart-button").removeClass("open"),$("aside.cart-container").removeClass("open")},App.prototype.getTemplate=function(e){var t=this;return $.when(einzl.deferreds.copy).then(function(){return $.get("/templates/"+e+".hbs").then(function(e){return e=t.insertCopy(e),Handlebars.compile(e)})})},App.prototype.initRouting=function(){var e=this,t=window.History;t.Adapter.bind(window,"statechange",function(){t.getState();e.route(null)})},$(document).ready(function(){window.einzl={pages:{},user:{likes:{},addresses:[],lang:function(){var e="de";return e&&"de"!==e?"en":"de"}()},products:[],templates:{},deferreds:{product:new $.Deferred,copy:new $.Deferred}}});var Page=function(e){this.model=e};Page.prototype.renderView=function(e){var t=this,n=this.template(this.model);this.view=$(n),this.initController(),$.when(einzl.deferreds.product).then(function(){t.insertProducts()})},Page.prototype.createView=function(){var e=this;return einzl.app.getTemplate(this.model.hbsPath).then(function(t){e.template=t,e.renderView(t)})},Page.prototype.start=function(){var e=this;this.view?(einzl.pages.active=this,$(window).scrollTop(0),$("body").removeClass("loading"),this.view.appendTo($("main"))):this.createView().then(function(){e.start()})},Page.prototype.initController=function(){this.view.find(".newsletter-form").each(function(){var e=$(this),t=e.find('input[type="email"]'),n=e.find('button.subscribe[type="submit"]');n.on("vclick",function(o){if(o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault(),!n.hasClass("loading"))if(e[0].checkValidity()&&t.val().length>0){n.addClass("loading");var i={email:t.val()};einzl.app.subscribe(i).always(function(e){n.removeClass("loading"),t.val("")}).done(function(){n.addTempClass("success",2e3)}).fail(function(){n.addTempClass("fail",2e3)})}else t.addClass("error"),t.one("focus",function(){t.removeClass("error")})})})},Page.prototype.insertProducts=function(){this.view.find("[data-product]").each(function(){var e=$(this),t=e.attr("data-product");$.each(einzl.products,function(){var n=this.model.id;return t===n?(this.view.clone(!0).appendTo(e),!1):void 0})})};var PageModel=Backbone.Model.extend({initialize:function(e){this.data=e,this.view=new PageView(this.data.hbsPath)}}),PageView=Backbone.View.extend({render:function(){var e=this;return this.template.then(function(t){var n=t();e.el=$(n),$("html, body").scrollTop(0),$("main").html(e.el),e.initController(),Einzlstck.Deferreds.products.then(function(){e.insertProducts()})})},initialize:function(e){var t=this;this.template=$.Deferred(),Einzlstck.Models.Shop.getTemplate(e).then(function(e){t.template.resolve(e)})},insertProducts:function(){console.log("insert products"),this.el.find("[data-product]").each(function(){var e=$(this),t=e.attr("data-product");$.each(Einzlstck.Models.Products,function(){var n=this;return n.data.id===t?($.when(n.view.template).then(function(){n.view.el.clone(!0).appendTo(e)}),!1):void 0})})},initController:function(){this.el.find(".newsletter-form").each(function(){var e=$(this),t=e.find('input[type="email"]'),n=e.find('button.subscribe[type="submit"]');n.on("vclick",function(o){if(o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault(),!n.hasClass("loading"))if(e[0].checkValidity()&&t.val().length>0){n.addClass("loading");var i={email:t.val()};Einzlstck.Models.Shop.subscribe(i).always(function(e){n.removeClass("loading"),t.val("")}).done(function(){n.addTempClass("success",2e3)}).fail(function(){n.addTempClass("fail",2e3)})}else t.addClass("error"),t.one("focus",function(){t.removeClass("error")})})})}}),Cart=function(){var e=this;this.getCart().then(function(){e.createView()})};Cart.prototype.removeItem=function(e){var t=this,n={action:"removeFromCart",cart:{id:t.model.id},product:{key:e,quantity:t.model.contents[e].quantity}};return einzl.app.askServer(n).done(function(e){t.model=e.cart,t.renderView()})},Cart.prototype.addItem=function(e){var t=this,n={action:"addToCart",cart:{id:t.model.id},product_id:e};return einzl.app.askServer(n).done(function(e){t.model=e.cart,t.renderView()})},Cart.prototype.getCart=function(){var e=this,t={action:"getCart",cart:{id:einzl.user.cart_id?einzl.user.cart_id:null}};return einzl.app.askServer(t).done(function(t){t.cart?(e.model=t.cart,einzl.user.cart_id=t.cart.id,einzl.app.saveUser()):notifyUser(einzl.copy.messages.noConnection,"error")})},Cart.prototype.createView=function(){var e=this;return einzl.app.getTemplate("modules/cart").then(function(t){e.template=t,e.renderView(t)})},Cart.prototype.initController=function(){var e=this;this.view.find(".item").off("vclick"),this.view.find(".item").on("vclick",function(e){$(e.currentTarget).toggleClass("selected").siblings("li").removeClass("selected"),e.preventDefault(),e.stopPropagation()}),this.view.find(".remove").off("vclick"),this.view.find(".remove").on("vclick",function(t){var n=$(t.currentTarget).closest("li.item"),o=$(this).closest("li").attr("data-product-key");n.hasClass("loading")||(n.addClass("loading"),e.removeItem(o)),t.stopPropagation(),t.preventDefault()})},Cart.prototype.insertIntoDOM=function(){$(".cart").html(""),this.view.clone(!0).appendTo($(".cart")),einzl.app.initAppRoutingLinks(),$(".total-items").text(this.model.total_items),$(".total-price").text(this.model.totals.rounded.with_tax)},Cart.prototype.renderView=function(){this.model.totals.rounded.with_tax=this.model.totals.rounded.with_tax.toFixed(2),this.model.totals.rounded.without_tax=this.model.totals.rounded.without_tax.toFixed(2),$.each(this.model.contents,function(){this.pricing.rounded.with_tax=this.pricing.rounded.with_tax.toFixed(2),this.pricing.rounded.without_tax=this.pricing.rounded.without_tax.toFixed(2)});var e=this.template(this.model);this.view=$(e),this.initController(),this.insertIntoDOM()};var Checkout=function(e){this.model=e,this.order={},Page.apply(this,arguments)};Checkout.prototype=Object.create(Page.prototype),Checkout.prototype.constructor=Checkout,Checkout.prototype.initController=function(){var e=this;console.log("init controller"),this.view.find(".new-address-button").on("vclick",function(e){$(e.currentTarget).closest(".unit").addClass("open-form")}),this.view.find('.new-address-form button[type="reset"]').on("vclick",function(t){$(t.currentTarget).closest(".unit").removeClass("open-form"),e.view.find("form").get(0).reset(),$(":focus").blur(),$(window).scrollTop(e.view.find("#billing-address").offset().top),t.preventDefault(),t.stopPropagation()}),this.view.find('.new-address-form button[type="submit"]').on("vclick",function(t){t.preventDefault(),t.stopPropagation();var n=$(t.currentTarget).closest("form");e.addUserAddress(n)}),this.view.find(".button.buy").on("vclick",function(t){var n=$(t.currentTarget);n.hasClass("loading")||(n.addClass("loading"),e.processOrder().always(function(){n.removeClass("loading")}).done(function(t){console.log(t),t.order.status?(einzl.user.cart_id=null,einzl.cart=new Cart,einzl.order=t.order.result,e.trackOrder(einzl.order),History.pushState("","Confirmation","/confirmation?orderID="+einzl.order.id)):notifyUser(einzl.copy.messages.nl_error,"error")}))}),einzl.app.getTemplate("/modules/addressList").then(function(t){e.addressTemplate=t,e.insertAddresses()}),this.view.find(".user-address-list").on("vclick","li",function(e){$(this).addClass("selected"),$(this).siblings("li").removeClass("selected"),e.preventDefault(),e.stopPropagation()})},Checkout.prototype.trackOrder=function(e){ga("require","ecommerce"),ga("ecommerce:addTransaction",{id:e.id,affiliation:"Einzelstück",revenue:e.total,shipping:e.shipping_price,tax:"0",currency:"EUR"}),$.each(e.cart.contents,function(e,t){ga("ecommerce:addItem",{id:e,name:t.name,sku:t.sku,category:t.category.value,price:t.total,quantity:t.quantity})}),ga("ecommerce:send")},Checkout.prototype.start=function(){Page.prototype.start.call(this),this.view&&einzl.cart.view&&(this.view.find(".cart").html(""),einzl.cart.view.clone(!0).appendTo(this.view.find(".cart"))),$(".cart-container").removeClass("open"),$(".cart-button").removeClass("open")},Checkout.prototype.processOrder=function(){console.log("process order");var e,t,n=$.Deferred(),o={},i=$("#billing-address"),a=i.find(".user-address-list .selected").first();if(!(a.length>0))return goToByScroll(i),notifyUser(einzl.copy.messages.checkout_noBillingAddress,"error"),n.reject();e=a.attr("data-address-id"),$.each(einzl.user.addresses,function(){return this.id===e?(t=this,!1):void 0}),o.billAd=t;var s,r,l=$("#shipping-address"),d=l.find(".user-address-list .selected").first();if(!(d.length>0))return goToByScroll(l),notifyUser(einzl.copy.messages.checkout_noShippingAddress,"error"),n.reject();if(s=d.attr("data-address-id"),$.each(einzl.user.addresses,function(){return this.id===s?(r=this,!1):void 0}),o.shipAd=r,!einzl.cart.model||einzl.cart.model.total_items<=0)return notifyUser(einzl.copy.messages.checkout_empty_cart,"error"),n.reject();var c=$("#payment-choice"),u=c.find('[name="paymentOption"]:checked').val();o.payment=u,o.shipping="6846";var p={action:"processOrder",order:o,cart:einzl.cart.model};return console.log(p),einzl.app.askServer(p).done(function(e){console.log(e)})},Checkout.prototype.insertAddresses=function(){var e=$(".user-address-list"),t=this.addressTemplate(einzl.user);e.html(t),e.find("li:first-child").addClass("selected"),0===einzl.user.addresses.length&&this.view.find("#billing-address").addClass("open-form")},Checkout.prototype.createUniqueAddressID=function(){var e=[];$.each(einzl.user.addresses,function(){e.push(this.id)});for(var t=1;$.inArray(t+"",e)>-1;)t++;return t+""},Checkout.prototype.validateAddressForm=function(e){if($(e).find("[required]").each(function(){var e=$(this);0===e.val().length&&(e.closest("div").addClass("error"),e.one("focus",function(){e.closest("div").removeClass("error")}))}),$(e).find(".error").length>0)return notifyUser(einzl.copy.messages.form_empty_input,"error"),!1;var t=$(e).find(".email input");return t.get(0).checkValidity()?e.checkValidity()?!0:!1:(t.closest("div").addClass("error"),t.one("focus",function(){t.closest("div").removeClass("error")}),notifyUser(einzl.copy.messages.form_email_invalid,"error"),!1)},Checkout.prototype.addUserAddress=function(e){if(!this.validateAddressForm(e.get(0)))return!1;var t={};t.first_name=e.find(".firstname input").val(),t.last_name=e.find(".lastname input").val(),t.email=e.find(".email input").val(),t.phone="000",t.address_1=e.find(".address_1 input").val(),t.postcode=e.find(".code input").val(),t.city=e.find(".city input").val(),t.county="--",t.country=e.find(".country select").val(),t.note=e.find(".note textarea").val(),t.id=this.createUniqueAddressID(),einzl.user.addresses.push(t),this.insertAddresses(),isLocalStorageNameSupported()&&(localStorage.einzl_user=JSON.stringify(einzl.user)),e.get(0).reset(),this.view.find(".open-form").removeClass("open-form")};var Confirmation=function(e){this.model=e,this.model.order=einzl.order,Page.apply(this,arguments)};Confirmation.prototype=Object.create(Page.prototype),Confirmation.prototype.constructor=Confirmation,Confirmation.prototype.start=function(){Page.prototype.start.call(this),this.view&&(this.resetView(),this.handleAccess())},Confirmation.prototype.resetView=function(){this.view.find(".payment-information").attr("style","")},Confirmation.prototype.handleAccess=function(){var e=this,t=getUrlParams();if(console.log(t),einzl.order||t.orderID)if(!einzl.order&&t.orderID){$("body").addClass("loading"),$("main").children("section").remove();var n={action:"getOrder",orderID:t.orderID};einzl.app.askServer(n).done(function(n){console.log(n),n.order&&n.order.status?(einzl.order=n.order.result,e.model.order=einzl.order,e.createView().then(function(){e.view.appendTo($("main")),$("body").removeClass("loading"),e.handlePayment(t)})):History.pushState("","Home","/")})}else e.handlePayment(t);else console.log("back to home"),History.pushState("","Home","/")},Confirmation.prototype.handlePayment=function(e){var t=this;if("Paid"===einzl.order.status.value)$("#paid").show();else if(e.PayerID&&e.paypal){t.view.find(".button.pay").addClass("loading").show();var n={action:"completePayment",orderID:einzl.order.id,token:e.token,PayerID:e.PayerID};einzl.app.askServer(n).done(function(e){console.log("order should be set to paid"),console.log(e)})}else if("Unpaid"===einzl.order.status.value||"Failed"===einzl.order.status.value||"Declined"===einzl.order.status.value)if("paypal-express"===einzl.order.gateway.data.slug){var o=t.view.find(".button.pay");o.addClass("loading");var n={action:"processPayment",orderID:einzl.order.id};einzl.app.askServer(n).done(function(e){console.log(e),o.removeClass("loading"),e.payment.status&&e.payment.result.url&&o.on("vclick",function(){window.open(e.payment.result.url)})}),$("#pay-paypal").show()}else $("#pay-manual").show()};var Product=function(e){this.model=e,this.model.pricing.rounded.with_tax=this.model.pricing.rounded.with_tax.toFixed(2),this.model.pricing.rounded.without_tax=this.model.pricing.rounded.without_tax.toFixed(2),this.createView()};Product.prototype.createView=function(){var e=einzl.templates.product(this.model);this.view=$(e),this.initController()},Product.prototype.addToCart=function(){return console.log(this.model),einzl.cart.addItem(this.model.id)},Product.prototype.initController=function(){var e=this;this.view.find(".drop.plus").on("vclick",function(e){$(this).closest(".details").toggleClass("collapsed expanded"),e.preventDefault(),e.stopPropagation()}),this.view.find(".drop.add-to-cart").on("vclick",function(t){var n=$(this);n.hasClass("loading")||(n.addClass("loading").removeClass("success fail"),e.addToCart().always(function(){n.removeClass("loading")}).done(function(){n.addTempClass("success",1500)}).fail(function(){n.addTempClass("fail",1500)})),t.preventDefault(),t.stopPropagation()}),this.view.find(".indicators span").each(function(e){$(this).on("vclick",function(e){var t=$(e.currentTarget),n=t.closest(".product");t.hasClass("fa-circle")||(n.find(".background .image.active").removeClass("active"),n.find(".background .image").eq(t.index()).addClass("active"),n.find(".indicators span.active").removeClass("active"),n.find(".indicators span").eq(t.index()).addClass("active"),n.find(".background").addTempClass("changeImage",500))})}),this.view.on("swipeleft",function(e){var t=$(e.currentTarget),n=t.find(".background .image.active"),o=t.find(".indicators span.active");n.next(".image").length>0&&(n.next().addClass("active"),o.next().addClass("active"),n.removeClass("active"),o.removeClass("active"))}),this.view.find(".drop.like").on("vclick",function(t){$(this).toggleClass("liked");var n=$(this).hasClass("liked");einzl.user.likes[e.model.id]=n,einzl.app.saveUser(),n?ga("send","event","product",e.model.id,"liked"):ga("send","event","product",e.model.id,"unliked"),einzl.app.handleLikes(),t.preventDefault(),t.stopPropagation()}),einzl.user.likes[this.model.id]&&this.view.find(".drop.like").addClass("liked"),0==this.model.stock_level&&this.view.addClass("out-of-stock")};var Router=Backbone.Router.extend({initialize:function(e){this.config=e,Backbone.history.start({pushState:!0}),$(document).on("vclick",'a:not([target="_blank"])',function(e){e.preventDefault();var t=$(this).attr("href");Einzlstck.Router.navigate(t,!0)})},routes:{checkout:"checkout",kasse:"checkout",":page":"page","*default":"page"},page:function(e){var t=e?"/"+e:"/";console.log("route to "+t);var n=this.getRouteConfig(t);Einzlstck.Pages[n.id]||(Einzlstck.Pages[n.id]=new PageModel(n)),Einzlstck.Pages[n.id].view.render()},checkout:function(e){var t="/checkout";console.log("route to "+t);var n=this.getRouteConfig(t);Einzlstck.Pages[n.id]||(Einzlstck.Pages[n.id]=new CheckoutModel(n)),Einzlstck.Pages[n.id].view.render()},confirmation:function(e){console.log("route to home"),Einzlstck.Views.Confirmation||(Einzlstck.Views.Confirmation=new PageView({hbsPath:"pages/confirmation.hbs"})),Einzlstck.Views.Confirmation.render()},getRouteConfig:function(e){var t=null;return $.each(this.config,function(){var n=!1;return $.each(this.slug,function(t,o){return o===e?(n=!0,!1):void 0}),n?(t=this,!1):void 0}),t?t:this.getRouteConfig("/404")}}),Shop=Backbone.Model.extend({initialize:function(e){var t=this;this.initEvents(),Einzlstck.Models.Copy=new Lang("de"),Einzlstck.Deferreds.copy.then(function(e){t.getProducts(),window.setTimeout(function(){notifyUser(e.messages.welcome[getRandomInt(0,e.messages.welcome.length-1)],"success")},2e3)})},initEvents:function(){$(document).on("vclick",".cart-button",function(e){var t=$(e.currentTarget),n=$(".hamburger-button");t.hasClass("open")?(t.removeClass("open"),$("aside.cart-container").removeClass("open"),$("body").removeClass("no-scroll-mobile")):(t.addClass("open"),$("aside.cart-container").addClass("open"),$("body").addClass("no-scroll-mobile"),n.removeClass("open"),$("header nav").removeClass("open")),e.preventDefault(),e.stopPropagation()}),$(document).on("vclick",".hamburger-button",function(e){var t=$(e.currentTarget),n=$(".cart-button");t.hasClass("open")?(t.removeClass("open"),$("header nav").removeClass("open"),$("body").removeClass("no-scroll-mobile")):(t.addClass("open"),$("header nav").addClass("open"),$("body").addClass("no-scroll-mobile"),n.removeClass("open"),$("aside.cart-container").removeClass("open")),e.preventDefault(),e.stopPropagation()})},getTemplate:function(e){return $.get("/templates/"+e).then(function(e){return Einzlstck.Deferreds.copy.then(function(t){return e=Einzlstck.Models.Copy.insertCopy(e,t),Handlebars.compile(e)})})},getProducts:function(){var e={action:"getProducts"};return this.askServer(e).done(function(e){e&&e.status?(Einzlstck.Models.Products=[],$.each(e.result,function(e){Einzlstck.Models.Products[e]=new ProductModel(this)}),Einzlstck.Deferreds.products.resolve(e)):(notifyUser(Einzlstck.Models.Copy.data.messages.noConnection,"error"),console.log("GET PRODUCTS FAILED"),console.log(e))})},askServer:function(e){return $.ajax({type:"POST",dataType:"json",url:"php/ajax.php",data:e}).done(function(e){}).fail(function(t,n,o){console.log("AJAX Call failed"),console.log("tried to send this data:"),console.log(e),console.log("response data:"),console.log(t),console.log(n),console.log(o)})},subscribe:function(e){var t={action:"subscribe",user:e};return this.askServer(t).done(function(e){console.log("user successfully subscribed"),console.log(e),notifyUser(Einzlstck.Models.Copy.data.messages.nl_subscribed,"success")}).fail(function(e){console.log("something is wrong with that email"),console.log(e),notifyUser(Einzlstck.Models.Copy.data.messages.nl_error,"error")})}});$(document).ready(function(){window.Einzlstck={Pages:{},Models:{},Views:{},Deferreds:{products:$.Deferred(),copy:$.Deferred()}},Einzlstck.Models.Shop=new Shop,Einzlstck.Router=new Router(config),Einzlstck.Models.User=new User,Einzlstck.Models.Cart=new Basket});var Basket=Backbone.Model.extend({initialize:function(){var e=this;this.getCart().then(function(){e.view.render(e.data).then(function(){})})},removeItem:function(e){var t=this,n={action:"removeFromCart",cart:{id:t.data.id},product:{key:e,quantity:t.data.contents[e].quantity}};return Einzlstck.Models.Shop.askServer(n).done(function(e){t.data=e.cart,t.view.render(t.data).then(function(){})})},addItem:function(e){var t=this,n={action:"addToCart",cart:{id:t.data.id},product_id:e};return Einzlstck.Models.Shop.askServer(n).done(function(e){t.data=e.cart,t.view.render(t.data).then(function(){})})},getCart:function(){var e=this;this.view=new BasketView;var t={action:"getCart",cart:{id:Einzlstck.Models.User.data.cart_id?Einzlstck.Models.User.data.cart_id:null}};return Einzlstck.Models.Shop.askServer(t).done(function(t){t.cart?(e.data=t.cart,Einzlstck.Models.User.data.cart_id=t.cart.id,Einzlstck.Models.User.saveToLocalstorage()):notifyUser(einzl.copy.messages.noConnection,"error")})}}),BasketView=Backbone.View.extend({template:$.Deferred(),initialize:function(){var e=this;Einzlstck.Models.Shop.getTemplate("modules/cart.hbs").then(function(t){e.template.resolve(t)})},render:function(e){var t=this;return e.totals.rounded.with_tax=e.totals.rounded.with_tax.toFixed(2),e.totals.rounded.without_tax=e.totals.rounded.without_tax.toFixed(2),$.each(e.contents,function(){this.pricing.rounded.with_tax=this.pricing.rounded.with_tax.toFixed(2),this.pricing.rounded.without_tax=this.pricing.rounded.without_tax.toFixed(2)}),this.template.then(function(n){var o=n(e);t.el=$(o),t.initController(),$(".cart").html(t.el.clone(!0)),$(".total-items").text(e.total_items),$(".total-price").text(e.totals.rounded.with_tax)})},initController:function(){this.el.find(".item").off("vclick"),this.el.find(".item").on("vclick",function(e){$(e.currentTarget).toggleClass("selected").siblings("li").removeClass("selected"),e.preventDefault(),e.stopPropagation()}),this.el.find(".remove").off("vclick"),this.el.find(".remove").on("vclick",function(e){var t=$(e.currentTarget).closest("li.item"),n=$(this).closest("li").attr("data-product-key");t.hasClass("loading")||(t.addClass("loading"),Einzlstck.Models.Cart.removeItem(n)),e.stopPropagation(),e.preventDefault()})}}),CheckoutModel=PageModel.extend({}),Lang=Backbone.Model.extend({initialize:function(e){this.language=e,this.getCopy()},getCopy:function(){var e=this;return $.getJSON("copy/"+this.language+".json",function(t){Einzlstck.Deferreds.copy.resolve(t.copy),e.data=t.copy})},insertCopy:function(e,t){var n=$("<div></div>").append(e);return n.find("[data-copy]").each(function(){var e=t[$(this).attr("data-copy")];$(this).html(e)}),n.find("[data-placeholder]").each(function(){var e=t.placeholders[$(this).attr("data-placeholder")];$(this).attr("placeholder",e)}),n.html()}}),ProductModel=Backbone.Model.extend({initialize:function(e){var t=this;this.data=e,this.view=new ProductView,this.view.render(this.data).then(function(){t.initController()})},addToCart:function(){return console.log("add this product to cart: "+this.data.id),Einzlstck.Models.Cart.addItem(this.data.id)},initController:function(){var e=this;this.view.el.find(".drop.plus").on("vclick",function(e){$(this).closest(".details").toggleClass("collapsed expanded"),e.preventDefault(),e.stopPropagation()}),this.view.el.find(".drop.add-to-cart").on("vclick",function(t){var n=$(this);n.hasClass("loading")||(n.addClass("loading").removeClass("success fail"),e.addToCart().always(function(){n.removeClass("loading")}).done(function(){n.addTempClass("success",1500)}).fail(function(){n.addTempClass("fail",1500)})),t.preventDefault(),t.stopPropagation()}),0==this.data.stock_level&&this.view.el.addClass("out-of-stock")}}),User=Backbone.Model.extend({data:{},initialize:function(){this.getFromLocalStorage()},saveToLocalstorage:function(){isLocalStorageNameSupported()&&(localStorage.einzl_user=JSON.stringify(this.data))},getFromLocalStorage:function(){if(isLocalStorageNameSupported()&&localStorage.einzl_user){var e=JSON.parse(localStorage.einzl_user);$.extend(this.data,e)}}}),ProductView=Backbone.View.extend({template:$.Deferred(),initialize:function(){var e=this;console.log("init product"),Einzlstck.Models.Shop.getTemplate("modules/product.hbs").then(function(t){e.template.resolve(t)})},render:function(e){var t=this;return this.template.then(function(n){var o=n(e);t.el=$(o)})}});