function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function removeSlash(e){return e.replace(/\/$/,"")}function goToByScroll(e){$("html,body").animate({scrollTop:e.offset().top-65},"slow")}function isLocalStorageNameSupported(){var e="test",t=window.sessionStorage;try{return t.setItem(e,"1"),t.removeItem(e),!0}catch(n){return!1}}function notifyUser(e,t){var n=$("#notification"),o=n.find(".message");n.addClass(t).removeClass("hide"),o.text(e),clearTimeout(t1),clearTimeout(t2),t1=window.setTimeout(function(){n.addClass("hide"),t2=window.setTimeout(function(){n.removeClass(t),o.text("")},1e3)},3500)}var userLang=navigator.language||navigator.userLanguage,config={routes:[{title:"Home",id:"home",slug:["/home","/",""],hbsPath:"/pages/home"},{title:"Rings",id:"rings",slug:["/rings","/ringe"],hbsPath:"/pages/rings"},{title:"Necklaces",id:"necklaces",slug:["/necklaces"],hbsPath:"/pages/necklaces"},{title:"Bracelets",id:"bracelets",slug:["/bracelets"],hbsPath:"/pages/bracelets"},{title:"Checkout",id:"checkout",slug:["/checkout"],hbsPath:"/pages/checkout"},{title:"Confirmation",id:"confirmation",slug:["/confirmation"],hbsPath:"/pages/confirmation"},{title:"Imprint",id:"imprint",slug:["/imprint"],hbsPath:"/pages/imprint"},{title:"Developer Page",id:"f12",slug:["/f12"],hbsPath:"/pages/f12"},{title:"404",id:"404",slug:["/404"],hbsPath:"/pages/404"}]},t1,t2;jQuery.fn.addTempClass=function(e,t){var n=$(this[0]);n.addClass(e),window.setTimeout(function(){n.removeClass(e)},t)};var App=function(e){var t=this;this.model=e,this.updateFromLocalStorage(),this.getCopy().then(function(){t.getProducts()}),this.initRouting(),this.initNavigation()};App.prototype.saveUser=function(){isLocalStorageNameSupported()&&(localStorage.einzl_user=JSON.stringify(einzl.user))},App.prototype.changeLanguageTo=function(e){einzl.user.lang=e,$("body").attr("data-active-lang",einzl.user.lang),this.getCopy().then(function(){$.each(einzl.pages,function(){this.createView()}),einzl.cart.createView()}),einzl.app.saveUser()},App.prototype.getCopy=function(){return $.getJSON("copy/"+einzl.user.lang+".json",function(e){einzl.copy=e.copy,einzl.deferreds.copy.resolve()}).done(function(){$("[data-copy]").each(function(){var e=einzl.copy[$(this).attr("data-copy")];$(this).html(e)}),window.setTimeout(function(){notifyUser(einzl.copy.messages.welcome[getRandomInt(0,einzl.copy.messages.welcome.length-1)],"success")},2e3)})},App.prototype.updateFromLocalStorage=function(){if(isLocalStorageNameSupported()&&localStorage.einzl_user){var e=JSON.parse(localStorage.einzl_user);$.extend(einzl.user,e)}$("body").attr("data-active-lang",einzl.user.lang)},App.prototype.getProducts=function(){var e=this,t={action:"getProducts"};return this.askServer(t).done(function(t){t&&t.status?e.getTemplate("modules/product").then(function(e){einzl.templates.product=e,$.each(t.result,function(e){einzl.products[e]=new Product(this)}),einzl.deferreds.product.resolve()}):(console.log("GET PRODUCTS FAILED"),console.log(t))})},App.prototype.askServer=function(e){return $.ajax({type:"POST",dataType:"json",url:"php/ajax.php",data:e}).done(function(){}).fail(function(t,n,o){console.log("AJAX Call failed"),console.log("tried to send this data:"),console.log(e),console.log("response data:"),console.log(t),console.log(n),console.log(o)})},App.prototype.initNavigation=function(){var e=this;$(".hamburger-button").on("vclick",function(e){$("header nav").toggleClass("open"),e.preventDefault(),e.stopPropagation()}),$(".cart-button").on("vclick",function(e){$(e.currentTarget).toggleClass("open"),$("aside.cart-container").toggleClass("open"),e.preventDefault(),e.stopPropagation()}),$(".language-button span").on("vclick",function(t){var n=$(t.currentTarget);e.changeLanguageTo(n.attr("data-language"))}),this.initAppRoutingLinks()},App.prototype.initAppRoutingLinks=function(){Modernizr.history&&($("a").off("vclick"),$("a").not('[target="_blank"]').on("vclick",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).attr("href"),n=$(this).attr("title"),o=window.location.pathname;o!==t&&History.pushState("",n,t)}))},App.prototype.subscribe=function(e){var t={action:"subscribe",user:e};return this.askServer(t).done(function(e){console.log("user successfully subscribed"),console.log(e),notifyUser(einzl.copy.messages.nl_subscribed,"success")}).fail(function(e){console.log("something is wrong with that email"),console.log(e),notifyUser(einzl.copy.messages.nl_error,"error")})},App.prototype.findDestination=function(e){var t=null;return $.each(this.model.routes,function(){var n=!1;return $.each(this.slug,function(t,o){return o===e?(n=!0,!1):void 0}),n?(t=this,!1):void 0}),t?t:this.findDestination("/404")},App.prototype.route=function(e){e||(e=removeSlash(window.location.pathname)),console.log("route to: "+e);var t=this.findDestination(e);einzl.pages[t.id]&&einzl.pages[t.id].view.length>0?einzl.pages[t.id].start():(einzl.pages[t.id]=new Page(t),einzl.pages[t.id]="checkout"==t.id?new Checkout(t):"confirmation"==t.id?new Confirmation(t):new Page(t),einzl.pages[t.id].start()),document.title=t.title+" - Einzelstück",ga("send","pageview"),$("header nav a").removeClass("active").filter('[href="'+t.slug[0]+'"]').addClass("active")},App.prototype.insertCopy=function(e){var t=$("<div></div>").append(e);return t.find("[data-copy]").each(function(){var e=einzl.copy[$(this).attr("data-copy")];$(this).html(e)}),t.html()},App.prototype.getTemplate=function(e){var t=this;return $.when(einzl.deferreds.copy).then(function(){return $.get("/templates/"+e+".hbs").then(function(e){return e=t.insertCopy(e),Handlebars.compile(e)})})},App.prototype.initRouting=function(){var e=this,t=window.History;t.Adapter.bind(window,"statechange",function(){t.getState();e.route(null)})},$(document).ready(function(){window.einzl={pages:{},user:{likes:{},addresses:[],lang:"de"==userLang?"de":"en"},products:[],templates:{},deferreds:{product:new $.Deferred,copy:new $.Deferred}},einzl.app=new App(config),einzl.app.route(null),einzl.cart=new Cart,ga("create","UA-46833918-1","auto")});var Page=function(e){this.model=e};Page.prototype.createView=function(){var e=this;return einzl.app.getTemplate(this.model.hbsPath).then(function(t){var n=t(e.model);e.view=$(n),$.when(einzl.deferreds.product).then(function(){e.insertProducts()}),e.initController()})},Page.prototype.initController=function(){this.view.find(".newsletter-form").each(function(){var e=$(this),t=e.find('input[type="email"]'),n=e.find('button.subscribe[type="submit"]');n.on("vclick",function(o){if(o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault(),!n.hasClass("loading"))if(e[0].checkValidity()&&t.val().length>0){n.addClass("loading");var a={email:t.val()};einzl.app.subscribe(a).always(function(){n.removeClass("loading"),t.val("")}).done(function(){n.addTempClass("success",2e3)}).fail(function(){n.addTempClass("fail",2e3)})}else t.addClass("error"),t.one("focus",function(){t.removeClass("error")})})})},Page.prototype.insertProducts=function(){this.view.find("[data-product]").each(function(){var e=$(this),t=e.attr("data-product");$.each(einzl.products,function(){var n=this.model.id;return t===n?(this.view.clone(!0).appendTo(e),!1):void 0})})},Page.prototype.start=function(){var e=this;this.view?(einzl.pages.active=this,$("main").children("section").detach(),$(window).scrollTop(0),this.view.appendTo($("main"))):this.createView().then(function(){e.start()})};var Cart=function(){var e=this;this.getCart().then(function(){e.createView()})};Cart.prototype.removeItem=function(e){var t=this,n={action:"removeFromCart",cart:{id:t.model.id},product:{key:e,quantity:t.model.contents[e].quantity}};return einzl.app.askServer(n).done(function(e){t.model=e.cart,t.render()})},Cart.prototype.addItem=function(e){var t=this,n={action:"addToCart",cart:{id:t.model.id},product_id:e};return einzl.app.askServer(n).done(function(e){t.model=e.cart,t.render()})},Cart.prototype.getCart=function(){var e=this,t={action:"getCart",cart:{id:einzl.user.cart_id?einzl.user.cart_id:null}};return einzl.app.askServer(t).done(function(t){console.log(t),e.model=t.cart,einzl.user.cart_id=t.cart.id,einzl.app.saveUser()})},Cart.prototype.createView=function(){var e=this;return einzl.app.getTemplate("modules/cart").then(function(t){e.template=t,e.render(),e.initController()})},Cart.prototype.initController=function(){var e=this,t=$(".cart");t.on("vclick",".item",function(e){$(e.currentTarget).toggleClass("selected").siblings("li").removeClass("selected"),e.preventDefault(),e.stopPropagation()}),t.on("vclick",".remove",function(t){var n=$(t.currentTarget).closest("li.item"),o=$(this).closest("li").attr("data-product-key");n.hasClass("loading")||(n.addClass("loading"),e.removeItem(o)),t.stopPropagation(),t.preventDefault()})},Cart.prototype.render=function(){var e=this.template(this.model);this.view=$(e),$(".cart").html(""),this.view.clone(!0).appendTo($(".cart")),einzl.app.initAppRoutingLinks(),$(".total-items").text(this.model.total_items),$(".total-price").text(this.model.totals.formatted.with_tax)};var Checkout=function(e){this.model=e,this.order={},Page.apply(this,arguments)};Checkout.prototype=Object.create(Page.prototype),Checkout.prototype.constructor=Checkout,Checkout.prototype.initController=function(){var e=this;this.view.find(".new-address-button").on("vclick",function(){e.view.find(".new-address-form").addClass("open")}),this.view.find('.new-address-form button[type="reset"]').on("vclick",function(t){e.view.find(".new-address-form").removeClass("open"),t.preventDefault(),t.stopPropagation()}),this.view.find('.new-address-form button[type="submit"]').on("vclick",function(t){t.preventDefault(),t.stopPropagation();var n=$(t.currentTarget).closest("form");e.addUserAddress(n)}),this.view.find(".button.buy").on("vclick",function(t){var n=$(t.currentTarget);n.hasClass("loading")||(n.addClass("loading"),e.processOrder().always(function(){n.removeClass("loading")}).done(function(e){e.order.status&&(einzl.user.cart_id=null,einzl.cart=new Cart,einzl.order=e.order.result,History.pushState("","Confirmation","/confirmation"))}))}),einzl.app.getTemplate("/modules/addressList").then(function(t){e.addressTemplate=t,e.insertAddresses()}),this.view.find(".user-address-list").on("vclick","li",function(e){$(this).addClass("selected"),$(this).siblings("li").removeClass("selected"),e.preventDefault(),e.stopPropagation()})},Checkout.prototype.start=function(){Page.prototype.start.call(this),this.view&&einzl.cart.view&&(console.log("insert cart into view"),this.view.find(".cart").html(einzl.cart.view)),$(".cart-container").removeClass("open"),$(".cart-button").removeClass("open")},Checkout.prototype.processOrder=function(){console.log("process order");var e,t,n={},o=$("#billing-address"),a=o.find(".user-address-list .selected").first();if(!(a.length>0))return console.log("error"),!1;e=a.attr("data-address-id"),$.each(einzl.user.addresses,function(){return this.id===e?(t=this,!1):void 0}),n.billAd=t;var i,r,s=$("#shipping-address"),l=s.find(".user-address-list .selected").first();if(!(l.length>0))return console.log("error"),!1;if(i=l.attr("data-address-id"),$.each(einzl.user.addresses,function(){return this.id===i?(r=this,!1):void 0}),n.shipAd=r,!einzl.cart.model||einzl.cart.model.total_items<=0)return console.log("error"),!1;var d=$("#payment-choice"),c=d.find('[name="paymentOption"]:checked').val();n.payment=c;var u={action:"processOrder",order:n,cart:einzl.cart.model};return einzl.app.askServer(u).done(function(e){console.log(e)})},Checkout.prototype.insertAddresses=function(){var e=$(".user-address-list"),t=this.addressTemplate(einzl.user);e.html(t),e.find("li:first-child").addClass("selected")},Checkout.prototype.createUniqueAddressID=function(){var e=[];$.each(einzl.user.addresses,function(){e.push(this.id)});for(var t=1;$.inArray(t+"",e)>-1;)t++;return t+""},Checkout.prototype.addUserAddress=function(e){var t={};t.first_name=e.find(".firstname").val(),t.last_name=e.find(".lastname").val(),t.email=e.find(".email").val(),t.phone="000",t.address_1=e.find(".address_1").val(),t.postcode=e.find(".code").val(),t.city=e.find(".city").val(),t.county="--",t.country=e.find(".country").val(),t.note=e.find(".note").val(),t.id=this.createUniqueAddressID(),einzl.user.addresses.push(t),this.insertAddresses(),isLocalStorageNameSupported()&&(localStorage.einzl_user=JSON.stringify(einzl.user)),e.get(0).reset(),this.view.find(".new-address-form").removeClass("open")};var Confirmation=function(e){this.model=e,einzl.order=JSON.parse('{"id":"914473201281532904","created_at":"2015-02-06 14:42:02","updated_at":"2015-02-06 14:42:02","customer":{"value":"Sumit","data":{"id":"523","order":null,"created_at":"2014-06-12 15:36:49","updated_at":"2014-06-12 15:36:49","first_name":"Sumit","last_name":"Kumar","email":"sk@outlook.com","group":null,"gender":"male","fbid":528632405,"lastlogin":null,"instaid":0,"hash":"IZNRGpoiIJ","role":"user"}},"gateway":{"value":"Manual","data":{"name":"Manual","slug":"manual","description":null,"enabled":true}},"status":{"value":"Unpaid","data":{"key":"unpaid","value":"Unpaid"}},"subtotal":55,"shipping_price":0,"total":65.45,"currency":{"value":"Euro","data":{"id":26,"code":"EUR","title":"Euro","enabled":true,"modifier":"+0","exchange_rate":1,"format":"EUR {price}","decimal_point":",","thousand_point":".","rounding":null,"default":false,"created_at":null,"updated_at":null}},"currency_code":"EUR","exchange_rate":1,"shipping":null,"ship_to":{"value":"","data":{"id":"914473199779972071","order":null,"created_at":"2015-02-06 14:42:02","updated_at":"2015-02-06 14:42:02","save_as":"","first_name":"Sumit","last_name":"Kumar","address_1":"Schwabstraße 32","address_2":"","postcode":"70197","country":{"value":"Germany","data":{"code":"DE","name":"Germany"}},"company":"","city":"Stuttgart","customer":{"value":"Sumit","data":{"id":"523","order":null,"created_at":"2014-06-12 15:36:49","updated_at":"2014-06-12 15:36:49","first_name":"Sumit","last_name":"Kumar","email":"sk@outlook.com","group":null,"gender":"male","fbid":528632405,"lastlogin":null,"instaid":0,"hash":"IZNRGpoiIJ","role":"user"}},"phone":"000","county":"--","instructions":""}},"bill_to":{"value":"","data":{"id":"914473199779972071","order":null,"created_at":"2015-02-06 14:42:02","updated_at":"2015-02-06 14:42:02","save_as":"","first_name":"Sumit","last_name":"Kumar","address_1":"Schwabstraße 32","address_2":"","postcode":"70197","country":{"value":"Germany","data":{"code":"DE","name":"Germany"}},"company":"","city":"Stuttgart","customer":{"value":"Sumit","data":{"id":"523","order":null,"created_at":"2014-06-12 15:36:49","updated_at":"2014-06-12 15:36:49","first_name":"Sumit","last_name":"Kumar","email":"sk@outlook.com","group":null,"gender":"male","fbid":528632405,"lastlogin":null,"instaid":0,"hash":"IZNRGpoiIJ","role":"user"}},"phone":"000","county":"--","instructions":""}}}'),this.model.order=einzl.order,Page.apply(this,arguments),this.handleOrder()};Confirmation.prototype=Object.create(Page.prototype),Confirmation.prototype.constructor=Confirmation,Confirmation.prototype.handleOrder=function(){console.log(this.model)};var Product=function(e){this.model=e,this.createView()};Product.prototype.createView=function(){var e=einzl.templates.product(this.model);this.view=$(e),this.initController()},Product.prototype.addToCart=function(){return console.log(this.model),einzl.cart.addItem(this.model.id)},Product.prototype.initController=function(){var e=this;this.view.find(".drop.plus").on("vclick",function(e){$(this).closest(".details").toggleClass("collapsed expanded"),e.preventDefault(),e.stopPropagation()}),this.view.find(".drop.add-to-cart").on("vclick",function(t){var n=$(this);n.hasClass("loading")||(n.addClass("loading").removeClass("success fail"),e.addToCart().always(function(){n.removeClass("loading")}).done(function(){n.addTempClass("success",1500)}).fail(function(){n.addTempClass("fail",1500)})),t.preventDefault(),t.stopPropagation()}),this.view.find(".drop.like").on("vclick",function(t){$(this).toggleClass("liked");var n=$(this).hasClass("liked");n?ga("send","event","product",e.model.id,"liked"):ga("send","event","product",e.model.id,"unliked"),einzl.user.likes[e.model.id]=n,einzl.app.saveUser(),t.preventDefault(),t.stopPropagation()}),einzl.user.likes[this.model.id]&&this.view.find(".drop.like").addClass("liked")};